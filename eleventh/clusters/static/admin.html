<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Admin - {{ node_address }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .refresh-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body x-data="clusterAdmin()" x-init="init()">
    <div class="header">
        <div class="container">
            <h1>🔗 Cluster Administration</h1>
            <p class="mb-0">Node: <code x-text="nodeAddress">{{ node_address }}</code></p>
        </div>
    </div>
    
    <div class="container">
        <!-- Cluster Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white fade-in">
                    <div class="card-body">
                        <h3 class="mb-0" x-text="stats.totalPeers">{{ total_peers }}</h3>
                        <p class="mb-0">Total Peers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white fade-in">
                    <div class="card-body">
                        <h3 class="mb-0" x-text="stats.healthyPeers">{{ healthy_peers }}</h3>
                        <p class="mb-0">Healthy</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-danger text-white fade-in">
                    <div class="card-body">
                        <h3 class="mb-0" x-text="stats.unhealthyPeers">{{ unhealthy_peers }}</h3>
                        <p class="mb-0">Unhealthy</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-secondary text-white fade-in">
                    <div class="card-body">
                        <h3 class="mb-0" x-text="stats.unknownPeers">{{ unknown_peers }}</h3>
                        <p class="mb-0">Unknown</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Peer Status Table -->
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Peer Health Status</h5>
                <div>
                    <span x-show="isRefreshing" class="loading-spinner me-2"></span>
                    <button 
                        class="btn btn-sm btn-outline-primary" 
                        @click="refreshData()"
                        :disabled="isRefreshing"
                    >
                        🔄 Refresh
                    </button>
                    <button 
                        class="btn btn-sm btn-outline-secondary ms-2" 
                        @click="toggleAutoRefresh()"
                        x-text="autoRefresh ? '⏸ Pause' : '▶️ Resume'"
                    >
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Last Check</th>
                            <th>Response Time</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="peers.length === 0">
                            <tr>
                                <td colspan="5" class="text-center text-muted">No peers configured</td>
                            </tr>
                        </template>
                        <template x-for="peer in peers" :key="peer.address">
                            <tr class="fade-in">
                                <td x-text="peer.address"></td>
                                <td>
                                    <span 
                                        class="badge"
                                        :class="{
                                            'bg-success': peer.status === 'healthy',
                                            'bg-danger': peer.status === 'unhealthy',
                                            'bg-secondary': peer.status === 'unknown'
                                        }"
                                        x-text="peer.status.toUpperCase()"
                                    ></span>
                                </td>
                                <td x-text="formatTimestamp(peer.last_check)"></td>
                                <td x-text="formatResponseTime(peer.response_time_ms)"></td>
                                <td class="text-danger" x-text="peer.error || '—'"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div class="card-footer refresh-info">
                Auto-refresh: <span x-text="autoRefresh ? 'ON' : 'OFF'"></span> ({{ health_check_interval }}s) | 
                Last updated: <span x-text="lastUpdated">{{ last_updated }}</span> |
                Next refresh in: <span x-text="countdown"></span>s
            </div>
        </div>
        
        <!-- API Endpoints -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">📡 Available Cluster Endpoints</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item">
                        <code>GET /cluster/health</code> - Health check for this node
                    </li>
                    <li class="list-group-item">
                        <code>GET /cluster/status</code> - Get cluster status
                    </li>
                    <li class="list-group-item">
                        <code>GET /cluster/peers</code> - List all peers
                    </li>
                    <li class="list-group-item">
                        <code>POST /cluster/peers/add?peer_address=...</code> - Add a peer
                    </li>
                    <li class="list-group-item">
                        <code>DELETE /cluster/peers/remove?peer_address=...</code> - Remove a peer
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <footer class="text-center mt-5 mb-3 text-muted">
        <small>Consul-like Plugin v0.1.0 | Built with Alpine.js</small>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function clusterAdmin() {
            return {
                nodeAddress: '{{ node_address }}',
                peers: [],
                stats: {
                    totalPeers: {{ total_peers }},
                    healthyPeers: {{ healthy_peers }},
                    unhealthyPeers: {{ unhealthy_peers }},
                    unknownPeers: {{ unknown_peers }}
                },
                lastUpdated: '{{ last_updated }}',
                isRefreshing: false,
                autoRefresh: true,
                refreshInterval: {{ health_check_interval }},
                countdown: {{ health_check_interval }},
                intervalId: null,
                countdownId: null,

                init() {
                    // Parse initial peer data from template
                    this.parsePeerData();
                    
                    // Start auto-refresh
                    this.startAutoRefresh();
                },

                parsePeerData() {
                    // This will be populated from the server-rendered table initially
                    // Then updated via AJAX
                    const peerTableHTML = `{{ peer_table }}`;
                    // For now, we'll fetch fresh data immediately
                    this.refreshData();
                },

                async refreshData() {
                    if (this.isRefreshing) return;
                    
                    this.isRefreshing = true;
                    try {
                        const response = await fetch('/cluster/status');
                        const data = await response.json();
                        
                        this.nodeAddress = data.node_address;
                        this.peers = data.peers.sort((a, b) => a.address.localeCompare(b.address));
                        this.stats = {
                            totalPeers: data.peers.length,
                            healthyPeers: data.healthy_peers,
                            unhealthyPeers: data.peers.filter(p => p.status === 'unhealthy').length,
                            unknownPeers: data.peers.filter(p => p.status === 'unknown').length
                        };
                        this.lastUpdated = this.formatTimestamp(data.last_updated);
                        
                        // Reset countdown
                        this.countdown = this.refreshInterval;
                    } catch (error) {
                        console.error('Failed to refresh data:', error);
                    } finally {
                        this.isRefreshing = false;
                    }
                },

                startAutoRefresh() {
                    if (this.intervalId) return;
                    
                    // Main refresh interval
                    this.intervalId = setInterval(() => {
                        if (this.autoRefresh) {
                            this.refreshData();
                        }
                    }, this.refreshInterval * 1000);

                    // Countdown timer
                    this.countdownId = setInterval(() => {
                        if (this.autoRefresh && this.countdown > 0) {
                            this.countdown--;
                        }
                        if (this.countdown <= 0) {
                            this.countdown = this.refreshInterval;
                        }
                    }, 1000);
                },

                toggleAutoRefresh() {
                    this.autoRefresh = !this.autoRefresh;
                    if (this.autoRefresh) {
                        this.countdown = this.refreshInterval;
                    }
                },

                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Never';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString();
                },

                formatResponseTime(ms) {
                    if (ms === null || ms === undefined) return 'N/A';
                    return `${ms.toFixed(2)} ms`;
                }
            }
        }
    </script>
</body>
</html>
